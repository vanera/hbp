#!/bin/sh

export POSTGRESQL_URL="postgres://kidxlcmjelupro:BIppLpyT2_5E2FsaDpbxv-X-Kv@ec2-54-221-236-4.compute-1.amazonaws.com:5432/d3tejf3n4ju9lc"
export LD_LIBRARY_PATH="/app/app/lib/"

source /app/packages/install.package.sh

indent() {
  sed -u 's/^/       /'
}



APP_CONF=/app/conf/app.nginx
APP_CONF_COMPILED=/app/conf/app.compiled.nginx

NGINX=$NGINX_ROOT/sbin/nginx
LUA=/app/vendor/lua/bin/lua

NGINX_ROOT=/app/vendor/nginx
NGINX_CONF=/app/conf/nginx.conf
NGINX_CONF_COMPILED=/app/conf/nginx.compiled.conf



cd "$NGINX_ROOT"

echo -e "-------------------------------------"
echo -e "bin/run ---> Compiling NGINX Config: "
echo -e "-------------------------------------"

cat "$NGINX_CONF" | $LUA /app/lib/ngx_compiler.lua > "$NGINX_CONF_COMPILED"
cat "$APP_CONF" | $LUA /app/lib/ngx_compiler.lua > "$APP_CONF_COMPILED"
mkdir -p logs

echo -e "-------------------------------------"
echo -e "bin/run ---> Starting NGINX"
echo -e "-------------------------------------"
$NGINX -p "$(pwd)" -c "$OUT_CONF"


