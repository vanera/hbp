#!/bin/sh

export POSTGRESQL_URL="postgres://kidxlcmjelupro:BIppLpyT2_5E2FsaDpbxv-X-Kv@ec2-54-221-236-4.compute-1.amazonaws.com:5432/d3tejf3n4ju9lc"
export LD_LIBRARY_PATH="/app/app/lib/"

export PATH=$PATH:/app/vendor/p7zip/bin:/app/vendor/nginx/sbin:/app/vendor/lua


indent() {
  sed -u 's/^/       /'
}

echo "-------------------------------------"
echo "bin/run ---> Installing Software: "
echo "-------------------------------------"

echo "Extracting Libraries" | indent

ROCK_DIR=/app
base=/app/vendor
mkdir -p $base


# package.tar.gz contains lua, lua-jit and nginx and friends
7za e $ROCK_DIR/packages/dist/php.7z -o$base/php -y > /dev/null 
7za e $ROCK_DIR/packages/dist/lua.7z -o$base/lua -y > /dev/null
7za e $ROCK_DIR/packages/dist/luajit.7z -o$base/luajit -y > /dev/null
7za e $ROCK_DIR/packages/dist/lualib.7z -o$base/lualib -y > /dev/null
7za e $ROCK_DIR/packages/dist/nginx.7z -o$base/nginx -y > /dev/null

echo "Finished installing the binary bundle" | indent



echo "-------------------------------------"
echo "bin/run ---> Preparing Configuration "
echo "-------------------------------------"

export APP_CONF=/app/conf/app.nginx
export APP_CONF_COMPILED=/app/conf/app.compiled.nginx

export LUA=/app/vendor/lua/lua

NGINX_ROOT=/app/vendor/nginx

NGINX_CONF=/app/conf/nginx.conf
NGINX_CONF_COMPILED=/app/conf/nginx.compiled.conf

NGINX=$NGINX_ROOT/nginx


echo "-------------------------------------"
echo "bin/run ---> Compiling NGINX Config  "
echo "-------------------------------------"


cat "$NGINX_CONF" | $LUA /app/lib/ngx_compiler.lua > "$NGINX_CONF_COMPILED"
cat "$APP_CONF" | $LUA /app/lib/ngx_compiler.lua > "$APP_CONF_COMPILED"
mkdir -p logs



echo "-------------------------------------"
echo "bin/run ---> Starting NGINX"
echo "-------------------------------------"
cd "$NGINX_ROOT"
LD_LIBRARY_PATH=/app/vendor/luajit $NGINX -p "$(pwd)" -c "$NGINX_CONF_COMPILED"


